<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LabMapper</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>

    <div class="app-wrapper">
        <!-- Mobile Header -->
        <div class="mobile-header d-md-none">
            <div class="brand mb-0">
                <i class="fa-solid fa-server"></i>
                <span>LabMapper</span>
            </div>
            <button class="btn btn-link text-white p-0" onclick="toggleSidebar()">
                <i class="fa-solid fa-bars fa-lg"></i>
            </button>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="brand d-none d-md-flex">
                <i class="fa-solid fa-server"></i>
                <span>LabMapper</span>
            </div>
            <nav class="d-flex flex-column w-100">
                <div class="nav-item active" id="nav-overview" onclick="showView('overview')">
                    <i class="fa-solid fa-chart-line"></i>
                    <span>Overview</span>
                </div>
                <div class="sidebar-separator">
                    <span>Lab Structure</span>
                </div>
                <div class="nav-item" id="nav-locations" onclick="showView('locations')">
                    <i class="fa-solid fa-map-location-dot"></i>
                    <span>Locations</span>
                </div>
                <div class="nav-item" id="nav-hardware" onclick="showView('hardware')">
                    <i class="fa-solid fa-microchip"></i>
                    <span>Hardware</span>
                </div>
                <div class="nav-item" id="nav-services" onclick="showView('services')">
                    <i class="fa-solid fa-layer-group"></i>
                    <span>Services</span>
                </div>
                <div class="nav-item" id="nav-connections" onclick="showView('connections')">
                    <i class="fa-solid fa-diagram-project"></i>
                    <span>Connections</span>
                </div>
                <div class="sidebar-separator">
                    <span>File Actions</span>
                </div>
                <div class="nav-item" id="nav-import" onclick="document.getElementById('sidebarFileInput').click()">
                    <i class="fa-solid fa-upload me-2"></i>
                    <span>Import Config</span>
                    <input type="file" id="sidebarFileInput" accept=".json" style="display:none" onchange="loadConfiguration(event)">
                </div>
                <div class="nav-item" id="nav-export" onclick="saveConfiguration()">
                    <i class="fa-solid fa-download me-2"></i>
                    <span>Export Config</span>
                </div>
                <div class="nav-item" id="nav-drawio" onclick="downloadDrawioXML()">
                    <i class="fa-solid fa-file-arrow-down"></i>
                    <span>Drawio XML</span>
                </div>
            </nav>
        </aside>

        <!-- Mobile Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Main Content -->
        <main class="main-content">
            
            <!-- Overview Dashboard -->
            <div id="overview-view" class="view-section">
                <div class="mb-5">
                    <h2 class="fw-bold mb-1">Infrastructure Overview</h2>
                    <p class="text-muted mb-0">Complete summary of your homelab environment.</p>
                </div>
                
                <!-- Stats Cards -->
                <div class="row g-4 mb-5">
                    <div class="col-md-3">
                        <div class="glass-card stat-card">
                            <div class="stat-icon">
                                <i class="fa-solid fa-map-location-dot"></i>
                            </div>
                            <div class="stat-value" id="stat-locations">0</div>
                            <div class="stat-label">Locations</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="glass-card stat-card">
                            <div class="stat-icon">
                                <i class="fa-solid fa-server"></i>
                            </div>
                            <div class="stat-value" id="stat-hardware">0</div>
                            <div class="stat-label">Hardware Devices</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="glass-card stat-card">
                            <div class="stat-icon">
                                <i class="fa-solid fa-layer-group"></i>
                            </div>
                            <div class="stat-value" id="stat-services">0</div>
                            <div class="stat-label">Services</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="glass-card stat-card">
                            <div class="stat-icon">
                                <i class="fa-solid fa-diagram-project"></i>
                            </div>
                            <div class="stat-value" id="stat-connections">0</div>
                            <div class="stat-label">Connections</div>
                        </div>
                    </div>
                </div>

                <!-- Hardware by Type -->
                <div class="row g-4 mb-5">
                    <div class="col-lg-6">
                        <div class="glass-card">
                            <h5 class="mb-4 border-bottom pb-3 border-secondary" style="border-color: rgba(255,255,255,0.1)!important;">
                                <i class="fa-solid fa-microchip me-2"></i>Hardware by Type
                            </h5>
                            <div id="hardware-by-type"></div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="glass-card">
                            <h5 class="mb-4 border-bottom pb-3 border-secondary" style="border-color: rgba(255,255,255,0.1)!important;">
                                <i class="fa-solid fa-layer-group me-2"></i>Services by Type
                            </h5>
                            <div id="services-by-type"></div>
                        </div>
                    </div>
                </div>

                <!-- Location Summary -->
                <div class="glass-card mb-5">
                    <h5 class="mb-4 border-bottom pb-3 border-secondary" style="border-color: rgba(255,255,255,0.1)!important;">
                        <i class="fa-solid fa-map-pin me-2"></i>Locations Summary
                    </h5>
                    <div id="locations-summary"></div>
                </div>

                <!-- Recent Hardware -->
                <div class="glass-card">
                    <h5 class="mb-4 border-bottom pb-3 border-secondary" style="border-color: rgba(255,255,255,0.1)!important;">
                        <i class="fa-solid fa-server me-2"></i>Hardware Inventory
                    </h5>
                    <div id="overview-hardware-list"></div>
                </div>
            </div>
            
            <!-- Locations View -->
            <div id="locations-view" class="view-section" style="display:none;">
                <div class="mb-5">
                    <h2 class="fw-bold mb-1">Locations</h2>
                    <p class="text-muted mb-0">Physical infrastructure sites.</p>
                </div>
                <div id="locations-list" class="row g-4"></div>
                <div id="locations-empty" class="text-center py-5 d-none">
                    <i class="fa-solid fa-map-pin fa-3x text-muted mb-3 opacity-25"></i>
                    <p class="text-muted">No locations found.</p>
                </div>
            </div>

            <!-- Hardware Grid View -->
            <div id="hardware-view" class="view-section" style="display:none;">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <h2 class="fw-bold mb-1">Hardware Inventory</h2>
                        <p class="text-muted mb-0">Servers, workstations, and networking gear.</p>
                    </div>
                    <div class="filter-container">
                        <label class="form-label text-uppercase small text-muted mb-2">Filter by Type</label>
                        <select class="form-select" id="hardware-type-filter" onchange="filterHardware()">
                            <option value="all">All Types</option>
                            <option value="server">Server / PC</option>
                            <option value="switch">Switch / Router</option>
                            <option value="ap">WiFi Access Point</option>
                            <option value="nas">NAS Appliance</option>
                            <option value="ups">UPS / Power</option>
                            <option value="iot">IoT Hub / Device</option>
                            <option value="camera">IP Camera</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div id="hardware-list" class="hardware-grid"></div>
                 <div id="hardware-empty" class="text-center py-5 d-none">
                    <i class="fa-solid fa-server fa-3x text-muted mb-3 opacity-25"></i>
                    <p class="text-muted">No hardware added yet.</p>
                </div>
            </div>

            <!-- Hardware Details Page (The New Elegant Page) -->
            <div id="hardware-detail-view" class="view-section" style="display:none;">
                <!-- Filled dynamically via JS -->
            </div>

            <!-- Services View -->
            <div id="services-view" class="view-section" style="display:none;">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <h2 class="fw-bold mb-1">Services & Containers</h2>
                        <p class="text-muted mb-0">Virtual machines, containers, and applications.</p>
                    </div>
                    <div class="filter-container">
                        <label class="form-label text-uppercase small text-muted mb-2">Filter by Type</label>
                        <select class="form-select" id="service-type-filter" onchange="filterServices()">
                            <option value="all">All Types</option>
                            <option value="vm">Virtual Machine (VM)</option>
                            <option value="lxc">LXC Container</option>
                            <option value="docker">Docker Container</option>
                            <option value="service">Application / Service</option>
                        </select>
                    </div>
                </div>
                <div id="services-list" class="hardware-grid"></div>
                 <div id="services-empty" class="text-center py-5 d-none">
                    <i class="fa-solid fa-layer-group fa-3x text-muted mb-3 opacity-25"></i>
                    <p class="text-muted">No services added yet.</p>
                </div>
            </div>

            <!-- Connections View -->
            <div id="connections-view" class="view-section" style="display:none;">
                <div class="mb-5">
                    <h2 class="fw-bold mb-1">Physical Connections</h2>
                    <p class="text-muted mb-0">Define cabling between ports.</p>
                </div>
                <div id="connections-list" class="row g-3"></div>
                <div id="connections-empty" class="text-center py-5 d-none">
                    <i class="fa-solid fa-diagram-project fa-3x text-muted mb-3 opacity-25"></i>
                    <p class="text-muted">No connections defined.</p>
                </div>
            </div>

            <!-- Add/Edit Forms (Hidden by default) -->
            <div id="add-location-view" class="view-section" style="display:none;">
                <div class="row justify-content-center">
                    <div class="col-lg-6">
                        <div class="glass-card">
                            <h3 class="mb-4" id="location-form-title">Add Location</h3>
                            <form onsubmit="saveLocation(event)">
                                <input type="hidden" name="edit_index" id="location-edit-index" value="">
                                <div class="mb-4">
                                    <label class="form-label text-uppercase small text-muted">Location Name</label>
                                    <input type="text" class="form-control" name="location_name" placeholder="e.g., Basement Rack" required>
                                </div>
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-secondary-soft" onclick="showView('locations')">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Location</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div id="add-hardware-view" class="view-section" style="display:none;">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="glass-card">
                            <h3 class="mb-4" id="hardware-form-title">Add Hardware</h3>
                            <form onsubmit="saveHardware(event)">
                                <input type="hidden" name="edit_index" id="hardware-edit-index" value="">
                                <div class="row g-3">
                                    <!-- Identity -->
                                    <div class="col-md-4">
                                        <label class="form-label text-uppercase small text-muted">Device Type</label>
                                        <select class="form-select" name="type" id="hw-type-select" onchange="updateFormFields()" required>
                                            <option value="">Select Type...</option>
                                            <option value="server">Server / PC</option>
                                            <option value="switch">Switch / Router</option>
                                            <option value="ap">WiFi Access Point</option>
                                            <option value="nas">NAS Appliance</option>
                                            <option value="ups">UPS / Power</option>
                                            <option value="iot">IoT Hub / Device</option>
                                            <option value="camera">IP Camera</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label text-uppercase small text-muted">Hostname / Name</label>
                                        <input type="text" class="form-control" name="hostname" placeholder="device-name" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label text-uppercase small text-muted">Role / Model</label>
                                        <input type="text" class="form-control" name="role" placeholder="Hypervisor, Core Switch">
                                    </div>
                                    
                                    <!-- Specs -->
                                    <div class="col-md-6 spec-field" data-spec="cpu">
                                        <label class="form-label text-uppercase small text-muted">CPU / Processor</label>
                                        <input type="text" class="form-control" name="cpu" placeholder="Intel i5-12600K">
                                    </div>
                                    <div class="col-md-6 spec-field" data-spec="ram">
                                        <label class="form-label text-uppercase small text-muted">RAM / Memory</label>
                                        <input type="text" class="form-control" name="ram" placeholder="64 GB DDR4">
                                    </div>
                                    <div class="col-md-6 spec-field" data-spec="storage">
                                        <label class="form-label text-uppercase small text-muted">Storage / Capacity</label>
                                        <input type="text" class="form-control" name="storage" placeholder="2TB NVMe">
                                    </div>
                                    <div class="col-md-6 spec-field" data-spec="gpu">
                                        <label class="form-label text-uppercase small text-muted">GPU / Accelerator</label>
                                        <input type="text" class="form-control" name="gpu" placeholder="RTX 3060">
                                    </div>

                                    <!-- Network Specifics -->
                                    <div class="col-md-6 spec-field" data-spec="ports" style="display:none;">
                                        <label class="form-label text-uppercase small text-muted">Port Count</label>
                                        <input type="text" class="form-control" name="ports" placeholder="e.g. 24, 48">
                                    </div>
                                    <div class="col-md-6 spec-field" data-spec="speed" style="display:none;">
                                        <label class="form-label text-uppercase small text-muted">Speed / Standard</label>
                                        <input type="text" class="form-control" name="speed" placeholder="1GbE, WiFi 6">
                                    </div>

                                    <!-- Power Specifics -->
                                    <div class="col-md-6 spec-field" data-spec="va_rating" style="display:none;">
                                        <label class="form-label text-uppercase small text-muted">VA Rating</label>
                                        <input type="text" class="form-control" name="va_rating" placeholder="1500 VA">
                                    </div>

                                    <!-- Network & Env -->
                                    <div class="col-md-4">
                                        <label class="form-label text-uppercase small text-muted">IP Address</label>
                                        <input type="text" class="form-control" name="ip" placeholder="10.0.0.5">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label text-uppercase small text-muted">Power (W)</label>
                                        <input type="text" class="form-control" name="power" placeholder="80W Idle">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label text-uppercase small text-muted">OS</label>
                                        <input type="text" class="form-control" name="os" placeholder="Proxmox">
                                    </div>

                                    <div class="col-md-12">
                                        <label class="form-label text-uppercase small text-muted">Location</label>
                                        <select class="form-select" id="location-select" name="location">
                                            <option value="">Select Location</option>
                                        </select>
                                    </div>

                                    <div class="col-12 mt-4">
                                        <label class="form-label d-flex justify-content-between align-items-center small text-muted text-uppercase">
                                            <span>NICs</span>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNicField()">+</button>
                                        </label>
                                        <div id="nics-section">
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control" name="nics[]" placeholder="e.g., Intel X520-DA2">
                                                <button type="button" class="btn btn-outline-danger" onclick="removeField(this)">-</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-end gap-2 mt-4">
                                    <button type="button" class="btn btn-secondary-soft" onclick="showView('hardware')">Cancel</button>
                                    <button type="submit" class="btn btn-primary px-4" id="hardware-submit-btn">Save</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div id="add-service-view" class="view-section" style="display:none;">
                <div class="row justify-content-center">
                    <div class="col-lg-6">
                        <div class="glass-card">
                            <h3 class="mb-4" id="service-form-title">Add Service</h3>
                            <form onsubmit="saveService(event)">
                                <input type="hidden" name="edit_index" id="service-edit-index" value="">
                                <div class="mb-3">
                                    <label class="form-label text-uppercase small text-muted">Type</label>
                                    <select class="form-select" name="type" required>
                                        <option value="vm">Virtual Machine (VM)</option>
                                        <option value="lxc">LXC Container</option>
                                        <option value="docker">Docker Container</option>
                                        <option value="service">Application / Service</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-uppercase small text-muted">Name</label>
                                    <input type="text" class="form-control" name="name" placeholder="e.g. Home Assistant, PiHole" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-uppercase small text-muted">Host</label>
                                    <select class="form-select" name="host" id="service-host-select" required>
                                        <option value="">Select Host...</option>
                                    </select>
                                    <div class="form-text text-muted small">Can be a physical node or a VM/LXC.</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-uppercase small text-muted">URL / Port</label>
                                    <input type="text" class="form-control" name="url" placeholder="http://10.0.0.5:8123">
                                </div>
                                <div class="mb-4">
                                    <label class="form-label text-uppercase small text-muted">Description</label>
                                    <textarea class="form-control" name="description" rows="3" placeholder="Brief description..."></textarea>
                                </div>
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-secondary-soft" onclick="showView('services')">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Service</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div id="add-connection-view" class="view-section" style="display:none;">
                <div class="row justify-content-center">
                    <div class="col-lg-6">
                        <div class="glass-card">
                            <h3 class="mb-4" id="connection-form-title">Add Connection</h3>
                            <form onsubmit="saveConnection(event)">
                                <input type="hidden" name="edit_index" id="connection-edit-index" value="">
                                
                                <!-- Source -->
                                <div class="mb-3">
                                    <label class="form-label text-uppercase small text-muted">Source Device</label>
                                    <select class="form-select" name="source_device" id="conn-source-dev" onchange="updatePortDropdown('source')" required>
                                        <option value="">Select Device...</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-uppercase small text-muted">Source Port</label>
                                    <select class="form-select" name="source_port" id="conn-source-port" required>
                                        <option value="">Select Device First...</option>
                                    </select>
                                </div>

                                <div class="text-center my-3 text-muted"><i class="fa-solid fa-arrow-down"></i></div>

                                <!-- Target -->
                                <div class="mb-3">
                                    <label class="form-label text-uppercase small text-muted">Target Device</label>
                                    <select class="form-select" name="target_device" id="conn-target-dev" onchange="updatePortDropdown('target')" required>
                                        <option value="">Select Device...</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label text-uppercase small text-muted">Target Port</label>
                                    <select class="form-select" name="target_port" id="conn-target-port" required>
                                        <option value="">Select Device First...</option>
                                    </select>
                                </div>

                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-secondary-soft" onclick="showView('connections')">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Connection</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Floating Action Buttons -->
    <div class="fab-container">
        <button class="fab-button fab-main" id="fab-main" onclick="toggleFabMenu()">
            <i class="fa-solid fa-plus"></i>
        </button>
        <div class="fab-menu" id="fab-menu">
            
            <button class="fab-button fab-item" onclick="showView('add-connection')" title="Add Connection">
                <i class="fa-solid fa-diagram-project"></i>
                <span class="fab-label">Add Connection</span>
            </button>
            <button class="fab-button fab-item" onclick="showView('add-service')" title="Add Service">
                <i class="fa-solid fa-layer-group"></i>
                <span class="fab-label">Add Service</span>
            </button>
            
            <button class="fab-button fab-item" onclick="addHardware()" title="Add Hardware">
                <i class="fa-solid fa-microchip"></i>
                <span class="fab-label">Add Hardware</span>
            </button>
            <button class="fab-button fab-item" onclick="showView('add-location')" title="Add Location">
                <i class="fa-solid fa-map-location-dot"></i>
                <span class="fab-label">Add Location</span>
            </button>
        </div>
    </div>

    <script src="static/js/app.js"></script>
</body>
</html>